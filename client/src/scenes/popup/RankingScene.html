<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ranking Scene (iframe React UI)</title>
    <style>
      body {
        background: #0f1724;
        color: #e6eef8;
        font-family: Inter, system-ui, -apple-system, Roboto, "Helvetica Neue",
          Arial;
        margin: 0;
        padding: 20px;
      }
      .container {
        max-width: 1100px;
        margin: 0 auto;
      }
      .card {
        background: #1a1d2e;
        border-radius: 12px;
        padding: 16px;
        border: 1px solid rgba(255, 255, 255, 0.06);
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 16px;
      }
      .left {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .title {
        font-size: 18px;
        font-weight: 600;
      }
      .tabs {
        display: flex;
        gap: 8px;
      }
      .btn {
        padding: 8px 14px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.06);
        color: #e6eef8;
        cursor: pointer;
      }
      .btn.active {
        background: linear-gradient(90deg, #bcab48, #ffa500);
        box-shadow: 0 0 24px rgba(168, 85, 247, 0.2);
      }
      .search {
        position: relative;
      }
      .search input {
        padding: 10px 12px 10px 36px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.03);
        color: inherit;
        border: 1px solid rgba(255, 255, 255, 0.06);
      }
      .search .icon {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
      }
      .table {
        margin-top: 12px;
        border-radius: 10px;
        overflow: hidden;
      }
      .table .row {
        display: grid;
        grid-template-columns: 80px 1fr 120px 150px;
        gap: 12px;
        padding: 12px 16px;
        align-items: center;
      }
      .table .headerRow {
        background: rgba(255, 255, 255, 0.03);
        color: #9aa3b2;
        font-size: 13px;
      }
      .table .odd {
        background: rgba(255, 255, 255, 0.01);
      }
      .badge {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .rankNum {
        font-size: 16px;
        font-weight: 600;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div id="root"></div>
    </div>

    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const { useState, useEffect } = React;

      function RankingScene() {
        // ‚≠ê rankingÏùÑ stateÎ°ú Î≥ÄÍ≤Ω
        const [rankings, setRankings] = useState({
          myRanking: {},
          rankings: [],
        });

        const [activeTab, setActiveTab] = useState("all");
        const [searchTerm, setSearchTerm] = useState("");

        // ‚≠ê Î∂ÄÎ™® ‚Üí iframe Î©îÏãúÏßÄ ÏàòÏã†
        useEffect(() => {
          window.parent.postMessage("RANKING_READY", "*");
          const handler = (event) => {
            if (event.data?.type === "RANKING_DATA") {
              setRankings(event.data.payload); // UI ÏóÖÎç∞Ïù¥Ìä∏
              window.parent.postMessage("RANKING_RENDER_COMPLETE", "*");
            }
          };

          window.addEventListener("message", handler);
          return () => window.removeEventListener("message", handler);
        }, []);

        const formatTime = (seconds) => {
          const hours = Math.floor(seconds / 3600);
          const mins = Math.floor((seconds % 3600) / 60);
          return `${hours}h ${mins}m`;
        };

        const getRankBadge = (rank) => {
          if (rank === 1)
            return { icon: "1", color: "#ffd700", bg: "rgba(255,215,0,0.12)" };
          if (rank === 2)
            return {
              icon: "2",
              color: "#c0c0c0",
              bg: "rgba(192,192,192,0.12)",
            };
          if (rank === 3)
            return {
              icon: "3",
              color: "#cd7f32",
              bg: "rgba(205,127,50,0.12)",
            };
          return { icon: null, color: "#999999", bg: "transparent" };
        };

        const filtered = (() => {
          const list = rankings.rankings;

          // Í≤ÄÏÉâÏñ¥ ÌïÑÌÑ∞
          const searchFiltered = list.filter((r) =>
            r.nickname.toLowerCase().includes(searchTerm.toLowerCase())
          );

          // Ï†ÑÏ≤¥ Îû≠ÌÇπ ÌÉ≠
          if (activeTab === "all") {
            return searchFiltered;
          }

          if (activeTab === "weekly") {
            const now = new Date();
            const day = now.getDay(); // 0 = ÏùºÏöîÏùº

            // Ïù¥Î≤à Ï£º ÏùºÏöîÏùº ÎÇ†Ïßú Íµ¨ÌïòÍ∏∞
            const sunday = new Date(now);
            sunday.setHours(0, 0, 0, 0);
            sunday.setDate(now.getDate() - day);

            return searchFiltered.filter((r) => {
              const played = new Date(r.lastPlayed);
              return played >= sunday;
            });
          }

          return searchFiltered;
        })();

        return (
          <div className="card">
            <div className="header">
              <div className="left">
                <img
                  src="/assets/icons/ranking_icon.png"
                  style={{ width: 18, height: 18 }}
                />
                <div className="title">Îû≠ÌÇπ</div>
              </div>

              <div style={{ display: "flex", gap: 12, alignItems: "center" }}>
                <div className="tabs">
                  <button
                    className={"btn " + (activeTab === "all" ? "active" : "")}
                    onClick={() => setActiveTab("all")}
                  >
                    Ï†ÑÏ≤¥ Îû≠ÌÇπ
                  </button>

                  <button
                    className={
                      "btn " + (activeTab === "weekly" ? "active" : "")
                    }
                    onClick={() => setActiveTab("weekly")}
                  >
                    Ï£ºÍ∞Ñ Îû≠ÌÇπ
                  </button>
                </div>

                <div className="search">
                  <span className="icon">üîç</span>
                  <input
                    placeholder="ÎãâÎÑ§ÏûÑ Í≤ÄÏÉâ..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                  />
                </div>

                <button
                  className="btn"
                  onClick={() => {
                    const iframe =
                      window.parent.document.getElementById("react-ui");
                    iframe.src = "about:blank"; // ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî
                    iframe.style.visibility = "hidden";
                  }}
                >
                  Îã´Í∏∞
                </button>
              </div>
            </div>

            <div style={{ marginTop: 12 }}>
              <div
                className="card"
                style={{ marginBottom: 12, border: "1px solid #ffa500" }}
              >
                <div
                  style={{
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                  }}
                >
                  <div>
                    <div style={{ fontSize: 13, color: "#9aa3b2" }}>
                      ÎÇ¥ Îû≠ÌÇπ
                    </div>
                    <div style={{ fontSize: 16 }}>
                      {rankings.myRanking.nickname}
                    </div>
                  </div>
                  <div style={{ display: "flex", gap: 70 }}>
                    <div style={{ textAlign: "center" }}>
                      <div style={{ fontSize: 13, color: "#9aa3b2" }}>ÏàúÏúÑ</div>
                      <div style={{ fontSize: 18, color: "#fff" }}>
                        #{rankings.myRanking.rank}
                      </div>
                    </div>
                    <div style={{ textAlign: "center" }}>
                      <div style={{ fontSize: 13, color: "#9aa3b2" }}>
                        ÏµúÍ≥† Ïä§ÌÖåÏù¥ÏßÄ
                      </div>
                      <div style={{ fontSize: 18, color: "#ffb347" }}>
                        {rankings.myRanking.maxStage}
                      </div>
                    </div>
                    <div style={{ textAlign: "center" }}>
                      <div style={{ fontSize: 13, color: "#9aa3b2" }}>
                        ÌîåÎ†àÏù¥ ÌÉÄÏûÑ
                      </div>
                      <div style={{ fontSize: 18, color: "#4ea8de" }}>
                        {formatTime(rankings.myRanking.playTime)}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div className="table card" style={{ padding: 0 }}>
                <div className="row headerRow">
                  <div style={{ marginLeft: 5 }}>Rank</div>
                  <div style={{ paddingLeft: 30 }}>Player</div>
                  <div style={{ textAlign: "center" }}>Max Stage</div>
                  <div style={{ textAlign: "center" }}>Play Time</div>
                </div>

                {filtered.map((p) => {
                  const badge = getRankBadge(p.rank);

                  return (
                    <div
                      key={`${p.rank}_${p.nickname}`}
                      className={"row " + (p.rank % 2 ? "odd" : "")}
                    >
                      <div style={{ display: "flex", alignItems: "center" }}>
                        <div
                          className="badge"
                          style={{ background: badge.bg, color: badge.color }}
                        >
                          {badge.icon || (
                            <span className="rankNum">{p.rank}</span>
                          )}
                        </div>
                      </div>

                      <div style={{ paddingLeft: 6 }}>
                        <span>{p.nickname}</span>
                      </div>

                      <div style={{ textAlign: "center" }}>
                        <span style={{ color: "#ffb347" }}>{p.maxStage}</span>
                      </div>

                      <div style={{ textAlign: "center" }}>
                        <span style={{ color: "#4ea8de" }}>
                          {formatTime(p.playTime)}
                        </span>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(
        React.createElement(RankingScene)
      );
    </script>
  </body>
</html>
